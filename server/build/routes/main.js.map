{"version":3,"file":"main.js","names":["_express","_interopRequireDefault","require","_passport","_jsonwebtoken","tokenList","router","express","Router","processLogoutRequest","request","response","cookies","refreshToken","refreshJwt","clearCookie","method","status","json","message","sendFile","root","get","post","passport","authenticate","session","_ref","_asyncToGenerator2","_regenerator","mark","_callee","wrap","_callee$","_context","prev","next","stop","_x","_x2","apply","arguments","_ref2","_callee3","_callee3$","_context3","_ref3","_callee2","error","user","_callee2$","_context2","abrupt","Error","login","err","body","_id","email","name","username","token","jwt","sign","process","env","JWT_SECRET","expiresIn","JWT_REFRESH_SECRET","cookie","t0","console","log","_x6","_x7","_x3","_x4","_x5","route","_default","exports"],"sources":["../../src/routes/main.js"],"sourcesContent":["import express from 'express';\r\nimport passport from 'passport';\r\nimport jwt from 'jsonwebtoken';\r\n\r\nconst tokenList = {};\r\nconst router = express.Router();\r\n\r\nfunction processLogoutRequest(request, response) {\r\n  if (request.cookies) {\r\n    const refreshToken = request.cookies.refreshJwt;\r\n    if (refreshToken in tokenList) delete tokenList[refreshToken];\r\n    response.clearCookie('jwt');\r\n    response.clearCookie('refreshJwt');\r\n  }\r\n  if (request.method === 'POST') {\r\n    response.status(200).json({ message: 'logged out', status: 200 });\r\n  } else if (request.method === 'GET') {\r\n    response.sendFile('logout.html', { root: './public' });\r\n  }\r\n}\r\n\r\nrouter.get('/status', (request, response) => {\r\n  response.status(200).json({ message: 'ok', status: 200 });\r\n});\r\n\r\nrouter.post('/signup', passport.authenticate('signup', { session: false }), async (request, response) => {\r\n  response.status(200).json({ message: 'signup successful', status: 200 });\r\n});\r\n\r\nrouter.post('/login', async (request, response, next) => {\r\n  // eslint-disable-next-line consistent-return\r\n  passport.authenticate('login', async (error, user) => {\r\n    try {\r\n      if (error) {\r\n        return next(error);\r\n      }\r\n      if (!user) {\r\n        return next(new Error('Username and password are required'));\r\n      }\r\n\r\n      request.login(user, { session: false }, (err) => {\r\n        if (err) return next(err);\r\n\r\n        // create our jwt\r\n        const body = {\r\n          _id: user._id,\r\n          email: user.email,\r\n          name: user.username,\r\n        };\r\n\r\n        const token = jwt.sign({ user: body }, process.env.JWT_SECRET, { expiresIn: 300 });\r\n        const refreshToken = jwt.sign(\r\n          { user: body }, process.env.JWT_REFRESH_SECRET, { expiresIn: 86400 },\r\n        );\r\n\r\n        // store tokens in cookie\r\n        response.cookie('jwt', token);\r\n        response.cookie('refreshJwt', refreshToken);\r\n\r\n        // store tokens in memory\r\n        tokenList[refreshToken] = {\r\n          token,\r\n          refreshToken,\r\n          email: user.email,\r\n          _id: user._id,\r\n          name: user.username,\r\n        };\r\n\r\n        // send the token to the user\r\n        return response.status(200).json({ token, refreshToken, status: 200 });\r\n      });\r\n    } catch (err) {\r\n      console.log(err);\r\n      return next(err);\r\n    }\r\n  })(request, response, next);\r\n});\r\n\r\nrouter.route('/logout')\r\n  .get(processLogoutRequest)\r\n  .post(processLogoutRequest);\r\n\r\nrouter.post('/token', (request, response) => {\r\n  const { refreshToken } = request.body;\r\n  if (refreshToken in tokenList) {\r\n    const body = {\r\n      email: tokenList[refreshToken].email,\r\n      _id: tokenList[refreshToken]._id,\r\n      name: tokenList[refreshToken].name,\r\n    };\r\n    const token = jwt.sign({ user: body }, process.env.JWT_SECRET, { expiresIn: 300 });\r\n\r\n    // update jwt\r\n    response.cookie('jwt', token);\r\n    tokenList[refreshToken].token = token;\r\n\r\n    response.status(200).json({ token, status: 200 });\r\n  } else {\r\n    response.status(401).json({ message: 'unauthorized', status: 401 });\r\n  }\r\n});\r\n\r\nexport default router;\r\n"],"mappings":"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"}
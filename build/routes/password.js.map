{"version":3,"sources":["../../src/routes/password.js"],"names":["email","process","env","EMAIL","password","PASSWORD","smtpTransport","nodemailer","createTransport","service","EMAIL_PROVIDER","auth","user","pass","handlebarsOptions","viewEngine","extName","defaultLayout","partialsDir","layoutsDir","viewPath","path","resolve","use","router","express","Router","post","request","response","userEmail","body","UserModel","findOne","status","json","message","buffer","crypto","randomBytes","token","toString","findByIdAndUpdate","_id","resetToken","resetTokenExp","Date","now","emailOptions","to","from","template","subject","context","name","url","PORT","sendMail","$gt","verifiedPassword","undefined","save","username"],"mappings":"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","sourcesContent":["import express from 'express';\r\nimport hbs from 'nodemailer-express-handlebars';\r\nimport nodemailer from 'nodemailer';\r\nimport path from 'path';\r\nimport crypto from 'crypto';\r\n\r\nimport UserModel from '../models/UserModel';\r\n\r\nconst email = process.env.EMAIL;\r\nconst password = process.env.PASSWORD;\r\n\r\nconst smtpTransport = nodemailer.createTransport({\r\n  service: process.env.EMAIL_PROVIDER,\r\n  auth: {\r\n    user: email,\r\n    pass: password,\r\n  },\r\n});\r\n\r\nconst handlebarsOptions = {\r\n  viewEngine: {\r\n    extName: '.hbs',\r\n    defaultLayout: null,\r\n    partialsDir: './templates/',\r\n    layoutsDir: './templates/',\r\n  },\r\n  viewPath: path.resolve('./templates/'),\r\n  extName: '.html',\r\n};\r\n\r\nsmtpTransport.use('compile', hbs(handlebarsOptions));\r\n\r\nconst router = express.Router();\r\n\r\nrouter.post('/forgot-password', async (request, response) => {\r\n  const userEmail = request.body.email;\r\n  const user = await UserModel.findOne({ email: userEmail });\r\n  if (!user) {\r\n    response.status(400).json({ message: 'invalid email', status: 400 });\r\n    return;\r\n  }\r\n\r\n  // create user token\r\n  const buffer = crypto.randomBytes(20);\r\n  const token = buffer.toString('hex');\r\n\r\n  // update user reset password token and exp\r\n  await UserModel.findByIdAndUpdate(\r\n    { _id: user._id }, { resetToken: token, resetTokenExp: Date.now() + 600000 },\r\n  );\r\n\r\n  // send user password reset email\r\n  const emailOptions = {\r\n    to: userEmail,\r\n    from: email,\r\n    template: 'forgot-password',\r\n    subject: 'MMO Password Reset',\r\n    context: {\r\n      name: 'joe',\r\n      url: `http://localhost:${process.env.PORT || 3000}/?token=${token}&scene=resetPassword`,\r\n    },\r\n  };\r\n  await smtpTransport.sendMail(emailOptions);\r\n\r\n  response.status(200).json({ message: 'An email has been sent to your email address. Password reset link is only valid for 10 minutes.', status: 200 });\r\n});\r\n\r\nrouter.post('/reset-password', async (request, response) => {\r\n  const userEmail = request.body.email;\r\n  const user = await UserModel.findOne({\r\n    resetToken: request.body.token,\r\n    resetTokenExp: { $gt: Date.now() },\r\n    email: userEmail,\r\n  });\r\n\r\n  if (!user) {\r\n    response.status(400).json({ message: 'invalid token', status: 400 });\r\n    return;\r\n  }\r\n\r\n  // ensure password was provided, and that the password matches the verified password\r\n  if (!request.body.password || !request.body.verifiedPassword\r\n    || request.body.password !== request.body.verifiedPassword) {\r\n    response.status(400).json({ message: 'passwords do not match', status: 400 });\r\n    return;\r\n  }\r\n\r\n  // update user model\r\n  user.password = request.body.password;\r\n  user.resetToken = undefined;\r\n  user.resetTokenExp = undefined;\r\n  await user.save();\r\n\r\n  // send user password update email\r\n  const emailOptions = {\r\n    to: userEmail,\r\n    from: email,\r\n    template: 'reset-password',\r\n    subject: 'MMO Password Reset Confirmation',\r\n    context: {\r\n      name: user.username,\r\n    },\r\n  };\r\n  await smtpTransport.sendMail(emailOptions);\r\n\r\n  response.status(200).json({ message: 'password updated', status: 200 });\r\n});\r\n\r\nexport default router;\r\n"],"file":"password.js"}